---
title: "NHANES Trend Analysis"
author: Keyu
output: 
  github_document
---



## Analytic approach  

Using the cleaned NHANES oral health summary dataset, we examined age- and sex-specific patterns of dental caries in the U.S. population. We restricted analyses to observations with race/ethnicity aggregated as “All” and focused on two outcomes for both primary and permanent dentition: **total caries experience** and **untreated caries**.  

For each pre-defined age group, we first described caries prevalence in the **most recent survey cycle**, then summarized **trends over time** using survey mid-year (1999–2017). Sex differences were evaluated by (1) plotting age-specific prevalence by sex in the latest cycle and (2) computing male–female differences (percentage points) across age groups and survey years.

## Results summary  

In the most recent available survey mid-year (2017 for permanent dentition and 2015 for some primary dentition measures), caries patterns showed strong age gradients. Permanent-tooth caries prevalence increased steeply with age: prevalence was lowest in children 6–11 years, higher in adolescents and young adults (12–29 years), and reached very high levels in mid- and older adulthood (40–69 years), where nearly all adults had experienced caries. Within each age group, females generally had slightly higher permanent-tooth caries prevalence than males, but sex differences were modest and confidence intervals overlapped.

Across survey years, time-trend plots showed that **total caries remained high** in young children for primary teeth and in adults for permanent teeth, reflecting the cumulative nature of disease. In contrast, **untreated caries** was consistently lower than total caries in every age group and tended to decline more clearly over time, suggesting improvements in treatment or access to dental care rather than substantial reductions in underlying disease occurrence.

Heatmaps of the **male–female gap in permanent-tooth caries** indicated that sex disparities were generally small (mostly within about ±5 percentage points) and showed no strong long-term trend. Females tended to have slightly higher prevalence in adolescent and young-adult groups, while gaps in older adults fluctuated around zero with no consistent pattern. Overall, these analyses highlight that **age-related accumulation of caries is the dominant inequality**, sex differences are relatively minor, and recent NHANES cycles show greater improvement in untreated disease than in total caries burden.

Taken together, these findings provide a coherent picture of dental caries patterns in recent NHANES data. Primary-tooth caries remains common in young children, with only modest changes in total caries over time but clearer declines in untreated disease, suggesting improved treatment among those who develop caries. For permanent teeth, caries accumulates across the life course, leading to very high prevalence in middle-aged and older adults, while untreated permanent caries has decreased or remained relatively low, again pointing to better restoration rather than true prevention. Sex gaps are small compared with the strong age gradients and show no consistent temporal trend, indicating that **age and dentition stage—rather than sex—are the main axes of inequality in U.S. dental caries burden.**

## Limitations  

This analysis has several important limitations. First, we relied on pre-aggregated NHANES oral health summary estimates by age, sex, and survey cycle rather than individual-level microdata. As a result, we could not re-apply survey weights, compute design-based standard errors ourselves, or perform formal hypothesis testing; all results should therefore be interpreted as descriptive summaries of the published estimates rather than inferential analyses. Second, because only the “race = All” strata were used, we could not describe racial/ethnic disparities in caries, which are known to be substantial. Third, the descriptive time trends do not account for potential changes in NHANES sampling, diagnostic criteria, or measurement error across cycles, and should not be interpreted causally. In addition, there are gaps in the time series where oral health summary data were unavailable or not used, so some survey cycles are missing; this limits our ability to assess smooth long-term trends and may exaggerate apparent changes between non-adjacent time points. Finally, all results are based on cross-sectional surveys, so we cannot distinguish between true cohort effects and the cumulative impact of aging on caries experience.

```{r setup, include=FALSE}
library(tidyverse)
library(readr)
library(dplyr)
library(ggplot2)
library(patchwork)

```

**Load the data**
```{r loading data}
nhanes <- read_csv("./datasets/nhanes_oral_clean.csv") %>% 
  janitor::clean_names() %>% 
  mutate(age_group = factor(age_group,
                       levels = c("2-5","6-11","12-19","20-29",
                                  "30-39","40-49","50-59","60-69")))
```
**Overall Time Trend by age group:**
```{r 2-5 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 2–5 (sex = All, primary dentition) ===
d25 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("2-5","2–5","2—5"),
    measure_clean %in% c("total_primary","untreated_primary")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_primary"     = "Total Dental Caries in Primary Teeth",
                           "untreated_primary" = "Untreated Dental Caries in Primary Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d25, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 2–5: Overall trend (sex = All, primary dentition)",
    subtitle = "Two series: Total caries (primary) vs Untreated caries (primary); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 6-11 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 6–11 (sex = All, primary dentition) ===
d611 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("6-11"),
    measure_clean %in% c("total_primary","untreated_primary")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_primary"     = "Total Dental Caries in Primary Teeth",
                           "untreated_primary" = "Untreated Dental Caries in Primary Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d611, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 6–11: Overall trend (sex = All, primary dentition)",
    subtitle = "Two series: Total caries (primary) vs Untreated caries (primary); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 12-19 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 12–19 (sex = All, permanent dentition) ===
d1219 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("12-19"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d1219, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 12–19: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 20-29 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 20–29 (sex = All, permanent dentition) ===
d2029 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("20-29"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d2029, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 20–29: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 30-39 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 30–39 (sex = All, permanent dentition) ===
d3039 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("30-39"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d3039, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 30–39: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 40-49 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 40–49 (sex = All, permanent dentition) ===
d4049 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("40-49"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d4049, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 40–49: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 50-59 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 50–59 (sex = All, permanent dentition) ===
d5059 <- nhanes %>% 
  filter(
    tolower(sex) == "all",
    age_group %in% c("50-59"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d5059, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 50–59: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 60-69 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 60–69 (sex = All, permanent dentition) ===
d6069 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("60-69"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d6069, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 60–69: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```


```{r load_patchwork, warning=FALSE, message=FALSE, fig.width=11, fig.height=9}

make_trend_plot <- function(age_values, age_title,
                            dentition = c("primary", "perm"),
                            show_x = FALSE, show_y = FALSE) {

  dentition <- match.arg(dentition)

  if (dentition == "primary") {
    measures <- c("total_primary", "untreated_primary")
    labels <- c(
      total_primary     = "Total Dental Caries in Primary Teeth",
      untreated_primary = "Untreated Dental Caries in Primary Teeth"
    )
  } else {
    measures <- c("total_perm", "untreated_perm")
    labels <- c(
      total_perm        = "Total Dental Caries in Permanent Teeth",
      untreated_perm    = "Untreated Dental Caries in Permanent Teeth"
    )
  }

  dat <- nhanes %>%
    filter(
      tolower(sex) == "all",
      age_group %in% age_values,
      measure_clean %in% measures
    ) %>%
    mutate(measure_label = recode(measure_clean, !!!labels)) %>%
    arrange(year_mid, measure_clean)

  ggplot(dat, aes(x = year_mid, y = percent,
                  color = measure_label, fill = measure_label)) +
    geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper),
                alpha = 0.06, color = NA) +
    geom_line(size = 1.3) +
    geom_point(size = 2.6) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 4)) +
    scale_color_manual(values = c(
      "Total Dental Caries in Primary Teeth"      = "#E16A5B",
      "Untreated Dental Caries in Primary Teeth"  = "#1F9AC9",
      "Total Dental Caries in Permanent Teeth"    = "#E16A5B",
      "Untreated Dental Caries in Permanent Teeth"= "#1F9AC9"
    )) +
    scale_fill_manual(values = c(
      "Total Dental Caries in Primary Teeth"      = "#E16A5B",
      "Untreated Dental Caries in Primary Teeth"  = "#1F9AC9",
      "Total Dental Caries in Permanent Teeth"    = "#E16A5B",
      "Untreated Dental Caries in Permanent Teeth"= "#1F9AC9"
    )) +
    labs(
      title = paste0("Ages ", age_title),
      x = if (show_x) "Survey year" else NULL,
      y = if (show_y) "Percent (%)" else NULL,
      color = "Measure",
      fill  = "Measure"
    ) +
    theme_minimal(base_size = 10) +
    theme(
      plot.title = element_text(size = 11, face = "bold"),
      axis.title = element_text(size = 9),
      axis.text  = element_text(size = 7),
      axis.text.x = element_text(size = 6, angle = 45, hjust = 1),   # ★ X 轴改小 + 倾斜
      panel.grid.minor = element_blank()
    )
}

# 8 个 panel
p_2_5  <- make_trend_plot(c("2-5", "2–5", "2—5"), "2–5",  "primary",  show_y = TRUE)
p_6_11 <- make_trend_plot("6-11", "6–11",           "primary")
p_12_19 <- make_trend_plot("12-19", "12–19",       "perm", show_y = TRUE)
p_20_29 <- make_trend_plot("20-29", "20–29",       "perm")
p_30_39 <- make_trend_plot("30-39", "30–39",       "perm", show_y = TRUE)
p_40_49 <- make_trend_plot("40-49", "40–49",       "perm")
p_50_59 <- make_trend_plot("50-59", "50–59",       "perm", show_y = TRUE, show_x = TRUE)
p_60_69 <- make_trend_plot("60-69", "60–69",       "perm", show_x = TRUE)

combined <- (p_2_5 + p_6_11) /
            (p_12_19 + p_20_29) /
            (p_30_39 + p_40_49) /
            (p_50_59 + p_60_69)

combined +
  plot_layout(guides = "collect") +
  plot_annotation(
    title    = "Overall Time Trend of Dental Caries by Age Group (sex = All)",
    subtitle = "NHANES; Total vs Untreated caries, shaded ribbons = 95% CI"
  ) &
  theme(
    legend.position = "bottom",                # ★ 图例放下面
    legend.box = "horizontal",
    legend.title = element_text(size = 9),
    legend.text  = element_text(size = 8)
  )
```

```{r trend_heatmap, warning=FALSE, message=FALSE, fig.width=8, fig.height=6}


# 1) choose outcome & dentition, e.g. total_primary (ages 2–11) or total_perm (10+)
target_meas <- "total_perm"  # change to "total_perm" for permanent dentition
base <- nhanes %>%
  filter(
    tolower(sex) %in% c("male", "female"),
    measure_clean == target_meas
  )

# 2) wide join: Male & Female side by side
male <- base %>%
  filter(sex == "Male") %>%
  select(age_group, year_mid, percent_M = percent)

female <- base %>%
  filter(sex == "Female") %>%
  select(age_group, year_mid, percent_F = percent)

gap <- male %>%
  inner_join(female, by = c("age_group", "year_mid")) %>%
  mutate(
    Gap_abs = percent_M - percent_F # >0: higher in males
  )

# 3) heatmap of sex gap over time & age
p_heat <- ggplot(gap, aes(x = year_mid, y = age_group, fill = Gap_abs)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    name = "Male − Female\n(percentage points)",
    low = "#3182bd", mid = "white", high = "#de2d26", midpoint = 0
  ) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Sex gap in total caries over time",
    subtitle = "Positive = higher in males; Negative = higher in females",
    x = "Survey mid-year", y = "Age group"
  ) +
  theme_minimal(base_size = 13)

print(p_heat)

```

```{r filtered_bar_chart, warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
# 3) Filter to race = All, sex = Male/Female, chosen outcome
bar <- nhanes %>%
  filter(
    tolower(sex) %in% c("male","female"),
    measure_clean == target_meas
  ) %>%
  mutate(
    sex = case_when(
      tolower(sex) == "male"   ~ "Male",
      tolower(sex) == "female" ~ "Female",
      TRUE ~ sex
    ),
    age_group = gsub("–|—", "-", age_group)  # unify dash
  )

# 4) Use latest survey mid-year
latest_year <- max(bar$year_mid, na.rm = TRUE)

latest <- bar %>%
  filter(year_mid == latest_year) %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c("2-5","6-11","12-19","20-29",
                 "30-39","40-49","50-59","60-69")
    )
  ) %>%
  arrange(age_group, sex)

# 5) Grouped bar chart: prevalence by age × sex
p_age_sex <- ggplot(latest,
                    aes(x = age_group, y = percent, fill = sex)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  # Optional: add 95% CI error bars if you want
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper),
                 position = position_dodge(width = 0.7),
                 width = 0.2, linewidth = 0.5) +
  labs(
    title = sprintf("Caries prevalence by age and sex (%s, latest year = %.0f)",
                    target_meas, 2017),
    x = "Age group",
    y = "Caries prevalence (%)",
    fill = "Sex",
    caption = 
      "Note: Error bars show 95% CIs from the NHANES oral health summary dataset.\nStandard errors were not re-estimeted from microdata, and no formal hypothesis testing was performed."
  ) +
  theme_minimal(base_size = 13)+
  theme(
    plot.caption = element_text(hjust = 0, size = 9, face = "italic")  
  )

print(p_age_sex)
```




