---
title: "NHANES Trend Analysis"
author: Keyu
output: 
  github_document
---

## Analytic approach  

Using NHANES oral health summary tables, we described age-, sex-, and race-specific prevalence of total and untreated caries in primary and permanent dentition. For each age group we plotted time trends (1999–2017); for permanent teeth we also examined sex-specific and race/ethnicity-specific trends and simple male–female and Black–White gaps. To summarize long-term change, we fit weighted linear regressions of prevalence on survey mid-year and reported slopes as percentage-point change per 10 years. Because we used published summary estimates rather than microdata, all analyses are descriptive.  

## Results summary  

In the most recent available survey mid-year (2017 for permanent dentition and 2015 for some primary measures), caries showed a strong age gradient: permanent-tooth caries was lowest in children 6–11 years, higher in adolescents and young adults, and nearly universal in adults 40–69 years, while primary-tooth caries remained common in children 2–11 years. Within each age group, females had slightly higher permanent-tooth caries prevalence than males, but sex differences were small.  

Over time, total caries stayed high in young children and older adults, whereas untreated caries was consistently lower and tended to decline, especially in children and younger adults. Regression slopes confirmed modest decreases in untreated caries (on the order of a few percentage points per decade) and little change in total caries among older adults. Among youth aged 6–19 years, Mexican American and Non-Hispanic Black groups had higher permanent-tooth caries than Non-Hispanic Whites across most survey years; gaps narrowed slightly but racial/ethnic disparities persisted.  

## Overall interpretation  

Overall, NHANES data suggest that dental caries is a lifelong, cumulative condition: primary caries remains common in children, permanent caries becomes almost universal in older adults, and declines in untreated disease are modest and concentrated at younger ages. Sex differences are small and relatively stable, while racial/ethnic gaps in youth remain visible despite overall improvement. Age and dentition stage, with superimposed racial/ethnic disparities, appear to be the main axes of inequality in U.S. dental caries burden.  

## Limitations  

This work uses pre-aggregated NHANES summary tables rather than individual-level data, so we cannot re-apply survey weights, recompute standard errors, or perform formal hypothesis testing; all results should be viewed as descriptive summaries of published estimates. Main analyses focus on “race = All” strata and have gaps in some survey years, limiting our ability to describe detailed racial/ethnic patterns or smooth long-term trends. In addition, NHANES is cross-sectional, so we cannot distinguish aging from cohort effects when interpreting changes over time.



```{r setup, include=FALSE}
library(tidyverse)
library(readr)
library(dplyr)
library(ggplot2)
library(patchwork)

```

**Load the data**
```{r loading data}
nhanes <- read_csv("./datasets/nhanes_oral_clean.csv") %>% 
  janitor::clean_names() %>% 
  mutate(age_group = factor(age_group,
                       levels = c("2-5","6-11","12-19","20-29",
                                  "30-39","40-49","50-59","60-69")))
race_df <- read_csv("./datasets/nhanes_oral.csv") %>% 
  janitor::clean_names() %>% 
  mutate(race=race_and_hispanic_origin) %>% 
  filter(age_group=="6-19",
         sex=="All") %>% 
  drop_na(percent)
```
**Overall Time Trend by age group:**
```{r 2-5 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 2–5 (sex = All, primary dentition) ===
d25 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("2-5","2–5","2—5"),
    measure_clean %in% c("total_primary","untreated_primary")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_primary"     = "Total Dental Caries in Primary Teeth",
                           "untreated_primary" = "Untreated Dental Caries in Primary Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d25, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 2–5: Overall trend (sex = All, primary dentition)",
    subtitle = "Two series: Total caries (primary) vs Untreated caries (primary); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 6-11 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 6–11 (sex = All, primary dentition) ===
d611 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("6-11"),
    measure_clean %in% c("total_primary","untreated_primary")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_primary"     = "Total Dental Caries in Primary Teeth",
                           "untreated_primary" = "Untreated Dental Caries in Primary Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d611, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 6–11: Overall trend (sex = All, primary dentition)",
    subtitle = "Two series: Total caries (primary) vs Untreated caries (primary); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 12-19 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 12–19 (sex = All, permanent dentition) ===
d1219 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("12-19"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d1219, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 12–19: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 20-29 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 20–29 (sex = All, permanent dentition) ===
d2029 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("20-29"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d2029, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 20–29: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 30-39 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 30–39 (sex = All, permanent dentition) ===
d3039 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("30-39"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d3039, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 30–39: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 40-49 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 40–49 (sex = All, permanent dentition) ===
d4049 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("40-49"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d4049, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 40–49: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 50-59 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 50–59 (sex = All, permanent dentition) ===
d5059 <- nhanes %>% 
  filter(
    tolower(sex) == "all",
    age_group %in% c("50-59"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d5059, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 50–59: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r 60-69 trend plot,warning=FALSE, message=FALSE}
# === Step: Overall trend for ages 60–69 (sex = All, permanent dentition) ===
d6069 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("60-69"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d6069, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 60–69: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey Mid-year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```


```{r load_patchwork, warning=FALSE, message=FALSE, fig.width=11, fig.height=9}

make_trend_plot <- function(age_values, age_title,
                            dentition = c("primary", "perm"),
                            show_x = FALSE, show_y = FALSE) {

  dentition <- match.arg(dentition)

  if (dentition == "primary") {
    measures <- c("total_primary", "untreated_primary")
    labels <- c(
      total_primary     = "Total Dental Caries in Primary Teeth",
      untreated_primary = "Untreated Dental Caries in Primary Teeth"
    )
  } else {
    measures <- c("total_perm", "untreated_perm")
    labels <- c(
      total_perm        = "Total Dental Caries in Permanent Teeth",
      untreated_perm    = "Untreated Dental Caries in Permanent Teeth"
    )
  }

  dat <- nhanes %>%
    filter(
      tolower(sex) == "all",
      age_group %in% age_values,
      measure_clean %in% measures
    ) %>%
    mutate(measure_label = recode(measure_clean, !!!labels)) %>%
    arrange(year_mid, measure_clean)

  ggplot(dat, aes(x = year_mid, y = percent,
                  color = measure_label, fill = measure_label)) +
    geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper),
                alpha = 0.06, color = NA) +
    geom_line(size = 1.3) +
    geom_point(size = 2.6) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 4)) +
    scale_color_manual(values = c(
      "Total Dental Caries in Primary Teeth"      = "#E16A5B",
      "Untreated Dental Caries in Primary Teeth"  = "#1F9AC9",
      "Total Dental Caries in Permanent Teeth"    = "#E16A5B",
      "Untreated Dental Caries in Permanent Teeth"= "#1F9AC9"
    )) +
    scale_fill_manual(values = c(
      "Total Dental Caries in Primary Teeth"      = "#E16A5B",
      "Untreated Dental Caries in Primary Teeth"  = "#1F9AC9",
      "Total Dental Caries in Permanent Teeth"    = "#E16A5B",
      "Untreated Dental Caries in Permanent Teeth"= "#1F9AC9"
    )) +
    labs(
      title = paste0("Ages ", age_title),
      x = if (show_x) "Survey year" else NULL,
      y = if (show_y) "Percent (%)" else NULL,
      color = "Measure",
      fill  = "Measure"
    ) +
    theme_minimal(base_size = 10) +
    theme(
      plot.title = element_text(size = 11, face = "bold"),
      axis.title = element_text(size = 9),
      axis.text  = element_text(size = 7),
      axis.text.x = element_text(size = 6, angle = 45, hjust = 1),   # ★ X 轴改小 + 倾斜
      panel.grid.minor = element_blank()
    )
}

# 8 个 panel
p_2_5  <- make_trend_plot(c("2-5", "2–5", "2—5"), "2–5",  "primary",  show_y = TRUE)
p_6_11 <- make_trend_plot("6-11", "6–11",           "primary")
p_12_19 <- make_trend_plot("12-19", "12–19",       "perm", show_y = TRUE)
p_20_29 <- make_trend_plot("20-29", "20–29",       "perm")
p_30_39 <- make_trend_plot("30-39", "30–39",       "perm", show_y = TRUE)
p_40_49 <- make_trend_plot("40-49", "40–49",       "perm")
p_50_59 <- make_trend_plot("50-59", "50–59",       "perm", show_y = TRUE, show_x = TRUE)
p_60_69 <- make_trend_plot("60-69", "60–69",       "perm", show_x = TRUE)

combined <- (p_2_5 + p_6_11) /
            (p_12_19 + p_20_29) /
            (p_30_39 + p_40_49) /
            (p_50_59 + p_60_69)

combined +
  plot_layout(guides = "collect") +
  plot_annotation(
    title    = "Overall Time Trend of Dental Caries by Age Group (sex = All)",
    subtitle = "NHANES; Total vs Untreated caries, shaded ribbons = 95% CI"
  ) &
  theme(
    legend.position = "bottom",                
    legend.box = "horizontal",
    legend.title = element_text(size = 9),
    legend.text  = element_text(size = 8)
  )
```

Long-term Regression (Slope)
```{r}
age_primary <- c("2-5", "6-11")
age_perm    <- c("12-19", "20-29", "30-39", "40-49", "50-59", "60-69")

measures_primary <- c("total_primary", "untreated_primary")
measures_perm    <- c("total_perm", "untreated_perm")

slope_dat <- nhanes %>%
  filter(
    tolower(sex) == "all",
    tolower(race_ethnicity) == "all",
    measure_clean %in% c(measures_primary, measures_perm),
    age_group %in% c(age_primary, age_perm)
  ) %>%
  mutate(
    dentition = case_when(
      measure_clean %in% measures_primary ~ "Primary",
      measure_clean %in% measures_perm    ~ "Permanent"
    ),
    outcome = case_when(
      str_detect(measure_clean, "total")     ~ "Total caries",
      str_detect(measure_clean, "untreated") ~ "Untreated caries",
      TRUE ~ measure_clean
    ),
    w = if_else(!is.na(se) & se > 0, 1 / (se^2), 1)
  )

fit_slope <- function(df) {
  m  <- lm(percent ~ year_mid, data = df, weights = w)
  b1 <- coef(m)[["year_mid"]]
  ci <- confint(m)["year_mid", ]

  tibble(
    slope_per_year      = b1,
    slope_per_10yrs     = b1 * 10,
    slope_10yr_lower    = ci[1] * 10,
    slope_10yr_upper    = ci[2] * 10,
    n_cycles            = nrow(df),
    first_year_mid      = min(df$year_mid),
    last_year_mid       = max(df$year_mid)
  )
}

slopes <- slope_dat %>%
  group_by(dentition, age_group, outcome) %>%
  group_modify(~ fit_slope(.x)) %>%
  ungroup() %>%
  mutate(
    across(starts_with("slope"), ~ round(.x, 2))
  ) %>%
  arrange(dentition, outcome, age_group)

slopes %>% 
  knitr::kable(caption = "Estimated linear time trends (slopes) in caries prevalence by dentition, age group, and outcome. Slopes are interpreted as percentage-point change per 10 years.")

```



```{r trend_heatmap, warning=FALSE, message=FALSE, fig.width=8, fig.height=6}


# 1) choose outcome & dentition, e.g. total_primary (ages 2–11) or total_perm (10+)
target_meas <- "total_perm"  # change to "total_perm" for permanent dentition
base <- nhanes %>%
  filter(
    tolower(sex) %in% c("male", "female"),
    measure_clean == target_meas
  )

# 2) wide join: Male & Female side by side
male <- base %>%
  filter(sex == "Male") %>%
  select(age_group, year_mid, percent_M = percent)

female <- base %>%
  filter(sex == "Female") %>%
  select(age_group, year_mid, percent_F = percent)

gap <- male %>%
  inner_join(female, by = c("age_group", "year_mid")) %>%
  mutate(
    Gap_abs = percent_M - percent_F # >0: higher in males
  )

# 3) heatmap of sex gap over time & age
p_heat <- ggplot(gap, aes(x = year_mid, y = age_group, fill = Gap_abs)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    name = "Male − Female\n(percentage points)",
    low = "#3182bd", mid = "white", high = "#de2d26", midpoint = 0
  ) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Sex gap in total caries over time",
    subtitle = "Positive = higher in males; Negative = higher in females",
    x = "Survey mid-year", y = "Age group"
  ) +
  theme_minimal(base_size = 13)

print(p_heat)

```

```{r filtered_bar_chart, warning=FALSE, message=FALSE, fig.width=8, fig.height=6}
# 3) Filter to race = All, sex = Male/Female, chosen outcome
bar <- nhanes %>%
  filter(
    tolower(sex) %in% c("male","female"),
    measure_clean == target_meas
  ) %>%
  mutate(
    sex = case_when(
      tolower(sex) == "male"   ~ "Male",
      tolower(sex) == "female" ~ "Female",
      TRUE ~ sex
    ),
    age_group = gsub("–|—", "-", age_group)  # unify dash
  )

# 4) Use latest survey mid-year
latest_year <- max(bar$year_mid, na.rm = TRUE)

latest <- bar %>%
  filter(year_mid == latest_year) %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c("2-5","6-11","12-19","20-29",
                 "30-39","40-49","50-59","60-69")
    )
  ) %>%
  arrange(age_group, sex)

# 5) Grouped bar chart: prevalence by age × sex
p_age_sex <- ggplot(latest,
                    aes(x = age_group, y = percent, fill = sex)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  # Optional: add 95% CI error bars if you want
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper),
                 position = position_dodge(width = 0.7),
                 width = 0.2, linewidth = 0.5) +
  labs(
    title = sprintf("Caries prevalence by age and sex (%s, latest year = %.0f)",
                    target_meas, 2017),
    x = "Age group",
    y = "Caries prevalence (%)",
    fill = "Sex",
    caption = 
      "Note: Error bars show 95% CIs from the NHANES oral health summary dataset.\nStandard errors were not re-estimeted from microdata, and no formal hypothesis testing was performed."
  ) +
  theme_minimal(base_size = 13)+
  theme(
    plot.caption = element_text(hjust = 0, size = 9, face = "italic")  
  )

print(p_age_sex)
```
Race/Ethnicity Trends
```{r}
# Choose outcome & age
target_measure <- "Total Dental Caries in Permanent Teeth"
target_age  <- "6-19"

race_keep <- c("Non-Hispanic White", "Non-Hispanic Black", "Mexican American")

race_trend <- race_df %>%
  mutate(
    age_group = gsub("–|—", "-", age_group)
  ) %>%
  filter(
    age_group == target_age,
    measure == target_measure,
    race %in% race_keep,
    tolower(sex) == "all"
  )

# Time trends by race
p_race_trend <- ggplot(race_trend,
                       aes(x = survey_years, y = percent, color = race)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  geom_ribbon(aes(ymin = lower_95_percent_ci_limit, ymax = upper_95_percent_ci_limit, fill = race, group = race),
              alpha = 0.15, color = NA) +
  labs(
    title = sprintf("Time trends in %s 
                    for ages %s by race/ethnicity",
                    target_measure, target_age),
    x = "Survey year", y = "Prevalence (%)",
    color = "Race/ethnicity", fill = "Race/ethnicity"
  ) +
  theme_minimal(base_size = 13)+
    theme(
    axis.text.x = element_text(angle = 45, hjust = 1)  
  )
p_race_trend
```


