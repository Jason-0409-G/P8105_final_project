---
title: "NHANES Trend Analysis"
author: Keyu
output: 
  github_document
---



## Analytic approach  

Using the cleaned NHANES oral health summary dataset, we examined age- and sex-specific patterns of dental caries in the U.S. population. We restricted analyses to observations with race/ethnicity aggregated as “All” and focused on two outcomes for both primary and permanent dentition: **total caries experience** and **untreated caries**.  

For each pre-defined age group, we first described caries prevalence in the **most recent survey cycle**, then summarized **trends over time** using survey mid-year (1999–2017). Sex differences were evaluated by (1) plotting age-specific prevalence by sex in the latest cycle and (2) computing male–female differences (percentage points) across age groups and survey years.

## Results summary  

In the **latest NHANES cycle**, permanent-tooth caries prevalence increased steeply with age: prevalence was lowest in children 6–11 years, higher in adolescents and young adults (12–29 years), and reached very high levels in mid- and older adulthood (40–69 years), where nearly all adults had experienced caries. Within each age group, females generally had slightly higher permanent-tooth caries prevalence than males, but sex differences were modest and confidence intervals overlapped.

Across survey years, time-trend plots showed that **total caries remained high** in young children for primary teeth and in adults for permanent teeth, reflecting the cumulative nature of disease. In contrast, **untreated caries** was consistently lower than total caries in every age group and tended to decline more clearly over time, suggesting improvements in treatment or access to dental care rather than substantial reductions in underlying disease occurrence.

Heatmaps of the **male–female gap in permanent-tooth caries** indicated that sex disparities were generally small (mostly within about ±5 percentage points) and showed no strong long-term trend. Females tended to have slightly higher prevalence in adolescent and young-adult groups, while gaps in older adults fluctuated around zero with no consistent pattern. Overall, these analyses highlight that **age-related accumulation of caries is the dominant inequality**, sex differences are relatively minor, and recent NHANES cycles show greater improvement in untreated disease than in total caries burden.

## Limitations  

This analysis has several important limitations. First, we relied on pre-aggregated NHANES summary estimates by age, sex, and survey cycle, so we could not adjust for individual-level covariates (e.g., socioeconomic status, insurance, or race/ethnicity) or formally model interactions beyond simple stratification. Second, because only the “race = All” strata were used, we could not describe racial/ethnic disparities in caries, which are known to be substantial. Third, the descriptive time trends do not account for potential changes in NHANES sampling, diagnostic criteria, or measurement error across cycles, and should not be interpreted causally. In addition, there are gaps in the time series where oral health summary data were unavailable or not used, so some survey cycles are missing; this limits our ability to assess smooth long-term trends and may exaggerate apparent changes between non-adjacent time points. Finally, all results are based on cross-sectional surveys, so we cannot distinguish between true cohort effects and the cumulative impact of aging on caries experience.


```{r}
library(tidyverse)
library(readr)
```

**Load the data**
```{r}
nhanes <- read_csv("./datasets/nhanes_oral_clean.csv") %>% 
  janitor::clean_names() %>% 
  mutate(age_group = factor(age_group,
                       levels = c("2-5","6-11","12-19","20-29",
                                  "30-39","40-49","50-59","60-69")))
```
**Overall Time Trend by age group:**
```{r}
# === Step: Overall trend for ages 2–5 (sex = All, primary dentition) ===
d25 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("2-5","2–5","2—5"),
    measure_clean %in% c("total_primary","untreated_primary")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_primary"     = "Total Dental Caries in Primary Teeth",
                           "untreated_primary" = "Untreated Dental Caries in Primary Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d25, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 2–5: Overall trend (sex = All, primary dentition)",
    subtitle = "Two series: Total caries (primary) vs Untreated caries (primary); shaded = 95% CI",
    x = "Survey year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r}
# === Step: Overall trend for ages 6–11 (sex = All, primary dentition) ===
d611 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("6-11"),
    measure_clean %in% c("total_primary","untreated_primary")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_primary"     = "Total Dental Caries in Primary Teeth",
                           "untreated_primary" = "Untreated Dental Caries in Primary Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d611, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 6–11: Overall trend (sex = All, primary dentition)",
    subtitle = "Two series: Total caries (primary) vs Untreated caries (primary); shaded = 95% CI",
    x = "Survey year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r}
# === Step: Overall trend for ages 12–19 (sex = All, permanent dentition) ===
d1219 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("12-19"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d1219, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 12–19: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r}
# === Step: Overall trend for ages 20–29 (sex = All, permanent dentition) ===
d2029 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("20-29"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d2029, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 20–29: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r}
# === Step: Overall trend for ages 30–39 (sex = All, permanent dentition) ===
d3039 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("30-39"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d3039, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 30–39: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r}
# === Step: Overall trend for ages 40–49 (sex = All, permanent dentition) ===
d4049 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("40-49"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d4049, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 40–49: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r}
# === Step: Overall trend for ages 50–59 (sex = All, permanent dentition) ===
d5059 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("50-59"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d5059, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 50–59: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r}
# === Step: Overall trend for ages 60–69 (sex = All, permanent dentition) ===
d6069 <- nhanes %>%
  filter(
    tolower(sex) == "all",
    age_group %in% c("60-69"),
    measure_clean %in% c("total_perm","untreated_perm")
  ) %>%
  mutate(
    measure_label = recode(measure_clean,
                           "total_perm"     = "Total Dental Caries in Permanent Teeth",
                           "untreated_perm" = "Untreated Dental Caries in Permanent Teeth")
  ) %>%
  arrange(year_mid, measure_clean)

ggplot(d6069, aes(x = year_mid, y = percent,
                     color = measure_label, fill = measure_label)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.15, color = NA) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Ages 60–69: Overall trend (sex = All, permanent dentition)",
    subtitle = "Two series: Total caries (permanent) vs Untreated caries (permanent); shaded = 95% CI",
    x = "Survey year", y = "Percent (%)", color = "Measure", fill = "Measure"
  ) +
  theme_minimal()
```

```{r}
# 2) Choose outcome (you can change this)
target_meas <- "total_perm"        # or "total_primary", "untreated_primary", "untreated_perm"

# 3) Filter to race = All, sex = All, chosen outcome
base <- nhanes %>%
  filter(
    tolower(sex) == "all",
    measure_clean == target_meas
  )

# 4) Choose latest survey mid-year
latest_year <- max(base$year_mid, na.rm = TRUE)

latest <- base %>%
  filter(year_mid == latest_year) %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c("2-5","6-11","12-19","20-29",
                 "30-39","40-49","50-59","60-69")
    )
  ) %>%
  arrange(age_group)

# 5) Age-group bar chart
p_age_bar <- ggplot(latest, aes(x = age_group, y = percent, fill = age_group)) +
  geom_col(width = 0.7) +
  scale_fill_brewer(palette = "Blues", direction = 1) +
  labs(
    title = sprintf("Caries prevalence by age group (%s, latest survey year %.1f)",
                    target_meas, latest_year),
    x = "Age group",
    y = "Caries prevalence (%)"
  ) +
  theme_minimal(base_size = 13) +
  theme(legend.position = "none")

print(p_age_bar)
```

```{r}


# 1) choose outcome & dentition, e.g. total_primary (ages 2–11) or total_perm (10+)
target_meas <- "total_perm"  # change to "total_perm" for permanent dentition

base <- nhanes %>%
  filter(
    tolower(sex) %in% c("male","female"),
    measure_clean == target_meas
  ) 

# 2) wide join: Male & Female side by side
male <- base %>%
  filter(sex == "Male") %>%
  select(age_group, year_mid, percent_M = percent)

female <- base %>%
  filter(sex == "Female") %>%
  select(age_group, year_mid, percent_F = percent)

gap <- male %>%
  inner_join(female, by = c("age_group","year_mid")) %>%
  mutate(
    Gap_abs = percent_M - percent_F   # >0: higher in males
  )

# 3) heatmap of sex gap over time & age
p_heat <- ggplot(gap, aes(x = year_mid, y = age_group, fill = Gap_abs)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    name = "Male − Female\n(percentage points)",
    low = "#3182bd", mid = "white", high = "#de2d26", midpoint = 0
  ) +
  scale_x_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Sex gap in total caries over time",
    subtitle = "Positive = higher in males; Negative = higher in females",
    x = "Survey mid-year", y = "Age group"
  ) +
  theme_minimal(base_size = 13)

print(p_heat)

```

```{r}
# 3) Filter to race = All, sex = Male/Female, chosen outcome
bar <- nhanes %>%
  filter(
    tolower(sex) %in% c("male","female"),
    measure_clean == target_meas
  ) %>%
  mutate(
    sex = case_when(
      tolower(sex) == "male"   ~ "Male",
      tolower(sex) == "female" ~ "Female",
      TRUE ~ sex
    ),
    age_group = gsub("–|—", "-", age_group)  # unify dash
  )

# 4) Use latest survey mid-year
latest_year <- max(bar$year_mid, na.rm = TRUE)

latest <- bar %>%
  filter(year_mid == latest_year) %>%
  mutate(
    age_group = factor(
      age_group,
      levels = c("2-5","6-11","12-19","20-29",
                 "30-39","40-49","50-59","60-69")
    )
  ) %>%
  arrange(age_group, sex)

# 5) Grouped bar chart: prevalence by age × sex
p_age_sex <- ggplot(latest,
                    aes(x = age_group, y = percent, fill = sex)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  # Optional: add 95% CI error bars if you want
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper),
                 position = position_dodge(width = 0.7),
                 width = 0.2, linewidth = 0.5) +
  labs(
    title = sprintf("Caries prevalence by age and sex (%s, latest year = %.0f)",
                    target_meas, 2017),
    x = "Age group",
    y = "Caries prevalence (%)",
    fill = "Sex"
  ) +
  theme_minimal(base_size = 13)

print(p_age_sex)
```




