---
title: "aggregated_data"
author: "Malcolm Chen"
date: "2025-11-24"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(stringr)
library(readr)
library(tidyr)
library(ggplot2)
library(scales)
```

Loading the datasets
```{r}
ca_data <- read.csv("datasets/clean_ca.csv")
nhanes_data <- read.csv("datasets/nhanes_oral_clean.csv")
```

Data processing for California dataset
```{r ca_data_processing}
ca_data <- ca_data %>%
  mutate(
    # Step 1: Standardized age ranges (replace the long horizontal lines in Age 1–2 with short horizontal lines)
    age_group_std = str_replace_all(age_group, "–", "-"),

    # Step 2: baseline life-stage group
    age_group_baseline = case_when(
      age_group_std %in% c("Age <1", "Age 1-2") ~ "Infant/Toddler",
      age_group_std %in% c("Age 3-5")           ~ "Early Childhood",
      age_group_std %in% c("Age 6-9")           ~ "Middle Childhood",
      age_group_std %in% c("Age 10-14", "Age 15-18") ~ "Adolescent",
      age_group_std %in% c("Age 19-20", "Age 21-34") ~ "Young Adult",
      age_group_std %in% c("Age 35-44", "Age 45-64") ~ "Middle Adult",
      age_group_std %in% c("Age 65-74", "Age 75+")   ~ "Older Adult",
      TRUE ~ NA_character_
    ),

    # Step 3: alternative life-stage 
    age_group_alt = case_when(
      age_group_std %in% c("Age <1", "Age 1-2") ~ "Infant/Toddler",
      age_group_std %in% c("Age 3-5")           ~ "Early Childhood",
      age_group_std %in% c("Age 6-9", "Age 10-14")   ~ "Middle Childhood", 
      age_group_std %in% c("Age 15-18")         ~ "Adolescent",
      age_group_std %in% c("Age 19-20", "Age 21-34") ~ "Young Adult",
      age_group_std %in% c("Age 35-44", "Age 45-64") ~ "Middle Adult",
      age_group_std %in% c("Age 65-74", "Age 75+")   ~ "Older Adult",
      TRUE ~ NA_character_
    ),

    # Step 4: year: "CY 2013" to numic 2013
    year_num = as.numeric(str_replace(year, "CY ", "")),


    util_rate_num = parse_number(utilization_rate) / 100
  )
```

# NHANES sort data processing
```{r nhanes_data_processing}
nhanes_period <- nhanes_data %>%
  # Only keep the overall
  filter(sex == "All", race_ethnicity == "All") %>%
  # Standardize age and map it to CA's life-stage
  mutate(
    age_group_std = stringr::str_replace_all(age_group, "–", "-"),
    age_group_baseline = dplyr::case_when(
      age_group_std == "2-5"                     ~ "Early Childhood",
      age_group_std == "6-11"                    ~ "Middle Childhood",
      age_group_std == "12-19"                   ~ "Adolescent",
      age_group_std %in% c("20-29", "30-39")     ~ "Young Adult",
      age_group_std %in% c("40-49", "50-59")     ~ "Middle Adult",
      age_group_std %in% c("60-69", "70 and over") ~ "Older Adult",
      TRUE ~ NA_character_
    ),
    period   = survey_years,       
    prev_num = percent / 100      
  ) %>%
  # combine
  group_by(period, age_group_baseline, measure_clean) %>%
  summarise(
    prev_num = mean(prev_num, na.rm = TRUE),
    .groups = "drop"
  )
```

# Establish a two-year cycle variable (e.g., 2013 and 2014 are both categorized under "2013-2014").
```{r}
ca_data <- ca_data %>%
  mutate(
    period_start = ifelse(year_num %% 2 == 1, year_num, year_num - 1),
    period_end   = period_start + 1,
    survey_years = paste0(period_start, "-", period_end)
  )
```

# Step 4: Aggregate over a two-year cycle (take the average).
```{r}
ca_data_2yr <- ca_data %>%
  group_by(survey_years, age_group_baseline, measure) %>%
  summarise(
    users = mean(users, na.rm = TRUE),
    denominator = mean(denominator, na.rm = TRUE),
    utilization_rate = mean(util_rate_num, na.rm = TRUE)
  ) %>%
  ungroup()
```


# switch from NHANES period to CA survey_years
```{r}
nhanes_period_clean <- nhanes_period %>%
  rename(
    survey_years = period,    
    nhanes_prev = prev_num    
  ) %>%
  group_by(survey_years, age_group_baseline) %>%   # aggregate life-stage 
  summarise(
    nhanes_prev = mean(nhanes_prev, na.rm = TRUE),
    .groups = "drop"
  )
```


# Merge
```{r}
merged_data <- ca_data_2yr %>%
  left_join(
    nhanes_period_clean,
    by = c("survey_years", "age_group_baseline")
  )
```

# Save
```{r}
write.csv(
  merged_data,
  file = "datasets/merged_ca_nhanes.csv",
  row.names = FALSE
)
```



