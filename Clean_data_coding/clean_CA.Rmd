---
title: "clean_CA"
output: github_document
author: Jason Gao
date: "2025-11-05"
---
# ---- upload packages ----

```{r upload packages, warnings=FALSE, message=FALSE}
library(tidyverse)
library(janitor)
library(knitr)
library(here)
setwd("..")
raw_data <- read_csv("datasets/ca_dental.csv")
```
# ---- clean datasets ----


```{r data cleaning }
# ---- Full data cleaning pipeline ----
# 1️⃣ Define age group order
age_order <- c(
  "Age <1","Age 1–2","Age 3–5","Age 6–9",
  "Age 10–14","Age 15–18","Age 19–20","Age 21–34",
  "Age 35–44","Age 45–64","Age 65–74","Age 75+"
)

# 2️⃣ Clean dataset
clean_data_basic <- raw_data |>
  # (1) Standardize column names
  clean_names() |>
  
  # (2) Remove invalid annotation rows
  mutate(desc_clean = str_to_lower(str_squish(users_annotation_description))) |>
  filter(
    is.na(desc_clean) |
      !desc_clean %in% c(
        "no data available",
        "cell suppressed for small numbers",
        "cell suppressed for complementary cell"
      )
  ) |>
  select(-desc_clean) |>
  
  # (3) Clean "measure" text
  mutate(
    measure = measure |>
      str_replace_all("[–—−]", "-") |>
      str_remove_all("\\s*\\([^()]*\\)") |>
      str_squish()
  ) |>
  
  # (4) Rename important columns
  rename(
    year      = calendar_year,
    age_group = age_filter,
    denominator = denominator_3_months_continuous_eligibility
  ) |>
  
  # (5) Standardize and order age groups
  mutate(
    age_group = age_group |>
      str_replace_all("[–—−-]", "–") |>
      str_squish() |>
      str_replace_all("^Age\\s*<\\s*1$", "Age <1") |>
      str_replace_all("^Age 1–2$|^Age 1-2$", "Age 1–2") |>
      str_replace_all("^Age 3–5$|^Age 3-5$", "Age 3–5") |>
      str_replace_all("^Age 6–9$|^Age 6-9$", "Age 6–9") |>
      str_replace_all("^Age 10–14$|^Age 10-14$", "Age 10–14") |>
      str_replace_all("^Age 15–18$|^Age 15-18$", "Age 15–18") |>
      str_replace_all("^Age 19–20$|^Age 19-20$", "Age 19–20") |>
      str_replace_all("^Age 21–34$|^Age 21-34$", "Age 21–34") |>
      str_replace_all("^Age 35–44$|^Age 35-44$", "Age 35–44") |>
      str_replace_all("^Age 45–64$|^Age 45-64$", "Age 45–64") |>
      str_replace_all("^Age 65–74$|^Age 65-74$", "Age 65–74") |>
      str_replace_all("^Age 75\\+$", "Age 75+"),
    age_group = factor(age_group, levels = age_order)
  ) |>
  
  # (6) Sort dataset
  arrange(year, age_group, measure)

# Quick check
clean_data_basic |> distinct(measure) |> arrange(measure)
clean_data_basic |> count(year, age_group) |> arrange(year, age_group)
head(clean_data_basic)

# 3️⃣ Simplify measure names
clean_data_simple <- clean_data_basic |>
  mutate(
    measure = case_when(
      measure == "Annual Dental Visit" ~ "Dental visit",
      measure == "Exams/Oral Health Evaluations" ~ "Exam/Evaluation",
      measure == "Treatment for Caries or Caries–Preventive Procedure" ~ "Caries treatment",
      measure == "Use of Dental Treatment Services" ~ "Treatment services",
      measure == "Use of Diagnostic Services" ~ "Diagnostic services",
      measure == "Use of Preventive Services" ~ "Preventive services",
      measure == "Use of Restorative Services" ~ "Restorative services",
      measure == "Use of Sealant" ~ "Sealant use",
      TRUE ~ measure
    )
  )

# 4️⃣ Keep only key variables & simplify names
clean_data_final <- clean_data_simple |>
  select(
    year,
    age_group,
    measure,
    users,
    denominator,
    utilization_percent   
  ) |>
  rename(
    year             = year,
    age_group        = age_group,
    measure          = measure,
    users            = users,
    denominator      = denominator,
    utilization_rate = utilization_percent   
  )


head(clean_data_final)
write_csv(clean_data_final, here("datasets", "clean_ca.csv"))
```

## Data Cleaning and Processing

The original Medi-Cal dental utilization dataset contained multiple annotation fields, coded measure names, and inconsistent formatting across variables.  
To prepare the data for analysis, we conducted a structured cleaning process in **R**, summarized as follows:

1. **Column normalization:**  
   All column names were standardized using `janitor::clean_names()` to ensure consistent lower-case formatting with underscores.

2. **Invalid record removal:**  
   Rows annotated as *“No data available”*, *“Cell suppressed for small numbers”*, or *“Cell suppressed for complementary cell”* were excluded.

3. **Measure text cleaning:**  
   All dash symbols were unified, parentheses and code ranges (e.g., CPT codes) were removed, and extra whitespace was trimmed.

4. **Age group standardization:**  
   Age labels were harmonized (e.g., `Age1-2`, `Age 1 – 2` → `Age 1–2`) and ordered logically from `<1` to `75+`.

5. **Annotation field removal:**  
   Redundant annotation columns were dropped, retaining only core analytical variables.

6. **Variable renaming:**  
   Key variables were renamed for clarity and consistency (e.g.,  
   `Calendar.Year` → `year`,  
   `Age.Filter` → `age_group`,  
   `Denominator..3.Months.Continuous.Eligibility.` → `denominator`,  
   `Utilization` → `utilization_rate`).

7. **Measure simplification:**  
   Long descriptive measure names were shortened to concise forms (e.g.,  
   *Annual Dental Visit* → *Dental visit*,  
   *Use of Preventive Services* → *Preventive services*).

The final cleaned dataset contains **six essential variables** —  
`year`, `age_group`, `measure`, `users`, `denominator`, and `utilization_rate` —  
suitable for descriptive and longitudinal analysis.




```{r}
rename_tbl <- tibble::tribble(
  ~original_name,        ~new_name,          ~meaning_en,
  "calendar_year",       "year",             "Reporting year (CY xxxx)",
  "age_filter",          "age_group",        "Standardized age group (ordered)",
  "measure",             "measure",          "Type of dental service (cleaned and simplified)",
  "users",               "users",            "Number of individuals using the service (numerator)",
  "denominator_3_months_continuous_eligibility", "denominator", "Population with ≥3 months continuous eligibility (denominator for utilization rate)",
  "utilization",         "utilization_rate", "Service utilization rate = users ÷ denominator"
)

knitr::kable(
  rename_tbl,
  align = "lll",
  caption = "Table 1: Final variable names and definitions"
)
```