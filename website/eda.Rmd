---
title: "Exploratory Data Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 10, fig.height = 6)
library(tidyverse)
library(plotly)
library(knitr)
library(scales)
```

<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px;">
<h2 style="margin-top: 0; color: white;">üìä Exploratory Data Analysis</h2>
<p style="margin-bottom: 0;">Visual exploration of temporal trends and patterns in dental health data</p>
</div>

---

## California Medi-Cal Data Analysis

### Data Loading and Preparation

```{r load-ca-data}
# PLACEHOLDER: Replace with actual data path when available
# ca_data <- read_csv("datasets/clean_ca.csv")

# For demonstration, creating sample structure
# Remove this and use actual data
ca_data <- tibble(
  year = rep(2013:2023, each = 12),
  age_group = rep(c("Age <1", "Age 1‚Äì2", "Age 3‚Äì5", "Age 6‚Äì9",
                    "Age 10‚Äì14", "Age 15‚Äì18", "Age 19‚Äì20", "Age 21‚Äì34",
                    "Age 35‚Äì44", "Age 45‚Äì64", "Age 65‚Äì74", "Age 75+"), times = 11),
  measure = sample(c("Preventive Services", "Treatment Services", "Sealants"), 
                   132, replace = TRUE),
  utilization_rate = runif(132, 0.2, 0.8)
)

# Clean and format data
ca_data <- ca_data %>%
  mutate(
    age_group = factor(age_group, levels = c(
      "Age <1", "Age 1‚Äì2", "Age 3‚Äì5", "Age 6‚Äì9",
      "Age 10‚Äì14", "Age 15‚Äì18", "Age 19‚Äì20", "Age 21‚Äì34",
      "Age 35‚Äì44", "Age 45‚Äì64", "Age 65‚Äì74", "Age 75+"
    ))
  )

head(ca_data) %>% kable(caption = "Sample of California Medi-Cal Data")
```

---

### Temporal Trends in Dental Service Utilization

#### Overall Utilization Trends (2013-2023)

```{r ca-overall-trend}
# PLACEHOLDER: Insert actual CA_Horizontal.Rmd analysis code
# This plot should show overall utilization trends over time

overall_trend <- ca_data %>%
  group_by(year) %>%
  summarise(avg_utilization = mean(utilization_rate, na.rm = TRUE))

p1 <- ggplot(overall_trend, aes(x = year, y = avg_utilization)) +
  geom_line(color = "#667eea", size = 1.5) +
  geom_point(color = "#764ba2", size = 3) +
  geom_vline(xintercept = 2020, linetype = "dashed", color = "red", alpha = 0.6) +
  annotate("text", x = 2020, y = max(overall_trend$avg_utilization), 
           label = "COVID-19", vjust = -0.5, color = "red") +
  scale_y_continuous(labels = percent_format()) +
  labs(
    title = "California Medi-Cal Dental Service Utilization Over Time",
    subtitle = "Average utilization across all age groups and service types",
    x = "Year",
    y = "Utilization Rate",
    caption = "Note: Dashed line indicates COVID-19 pandemic onset (2020)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11, color = "gray40"),
    panel.grid.minor = element_blank()
  )

ggplotly(p1) %>%
  layout(hovermode = "x unified")
```

<div style="background: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px;">
<strong>‚ö†Ô∏è PLACEHOLDER:</strong> Replace the sample data and plot with actual analysis from <code>CA_Horizontal.Rmd</code>. Include:
<ul>
<li>Actual utilization trends by measure type</li>
<li>COVID-19 impact assessment</li>
<li>Recovery patterns post-pandemic</li>
</ul>
</div>

---

#### Utilization by Age Group

```{r ca-age-trends}
# PLACEHOLDER: Age-specific trends analysis
age_trends <- ca_data %>%
  filter(measure == "Preventive Services") %>%
  group_by(year, age_group) %>%
  summarise(avg_util = mean(utilization_rate, na.rm = TRUE), .groups = "drop")

p2 <- ggplot(age_trends, aes(x = year, y = avg_util, color = age_group, group = age_group)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_color_viridis_d(option = "turbo") +
  scale_y_continuous(labels = percent_format()) +
  labs(
    title = "Preventive Service Utilization by Age Group",
    subtitle = "Temporal trends across different age categories",
    x = "Year",
    y = "Utilization Rate",
    color = "Age Group"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "right"
  )

ggplotly(p2)
```

---

#### Service Type Comparison

```{r ca-service-comparison}
# PLACEHOLDER: Service type comparison
service_trends <- ca_data %>%
  group_by(year, measure) %>%
  summarise(avg_util = mean(utilization_rate, na.rm = TRUE), .groups = "drop")

p3 <- ggplot(service_trends, aes(x = year, y = avg_util, fill = measure)) +
  geom_area(alpha = 0.6, position = "identity") +
  scale_fill_manual(values = c("#667eea", "#764ba2", "#f093fb")) +
  scale_y_continuous(labels = percent_format()) +
  labs(
    title = "Dental Service Utilization by Service Type",
    subtitle = "Comparing preventive services, treatments, and sealants",
    x = "Year",
    y = "Utilization Rate",
    fill = "Service Type"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

ggplotly(p3)
```

<div style="background: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px;">
<strong>‚ö†Ô∏è PLACEHOLDER:</strong> Add actual service type analysis from your CA analysis files, including sealant utilization patterns specifically for children and adolescents.
</div>

---

### Age Group Comparisons

```{r ca-age-heatmap}
# PLACEHOLDER: Heatmap of utilization by age and year
age_year_matrix <- ca_data %>%
  group_by(year, age_group) %>%
  summarise(avg_util = mean(utilization_rate, na.rm = TRUE), .groups = "drop")

p4 <- ggplot(age_year_matrix, aes(x = factor(year), y = age_group, fill = avg_util)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(
    low = "#f093fb", 
    mid = "#667eea", 
    high = "#764ba2",
    midpoint = 0.5,
    labels = percent_format()
  ) +
  labs(
    title = "Dental Service Utilization Heatmap",
    subtitle = "Utilization rates across age groups and years",
    x = "Year",
    y = "Age Group",
    fill = "Utilization\nRate"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggplotly(p4)
```

---

## NHANES Data Analysis

### NHANES Data Overview

```{r load-nhanes-data}
# PLACEHOLDER: Replace with actual NHANES data
# nhanes_data <- read_csv("datasets/clean_nhanes.csv")

# Sample structure for demonstration
nhanes_data <- tibble(
  year = rep(seq(1999, 2020, 2), each = 24),
  age_group = rep(c("2-5", "6-9", "10-19", "20-34", "35-64", "65+"), each = 4, times = 11),
  demographic = rep(c("Overall", "Male", "Female", "Other"), times = 66),
  caries_prevalence = runif(264, 20, 80),
  untreated_caries = runif(264, 5, 30),
  se = runif(264, 1, 5)
)

head(nhanes_data) %>% kable(caption = "Sample of NHANES Oral Health Data")
```

<div style="background: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px;">
<strong>‚ö†Ô∏è PLACEHOLDER:</strong> Load and display actual NHANES cleaned data from <code>Clean_NHANES-Data.Rmd</code>
</div>

---

### Temporal Trends in Dental Caries

#### Overall Caries Prevalence (1999-2020)

```{r nhanes-overall-trend}
# PLACEHOLDER: Insert actual NHANES trend analysis

overall_caries <- nhanes_data %>%
  filter(demographic == "Overall") %>%
  group_by(year) %>%
  summarise(
    avg_caries = mean(caries_prevalence, na.rm = TRUE),
    avg_untreated = mean(untreated_caries, na.rm = TRUE)
  )

p5 <- ggplot(overall_caries, aes(x = year)) +
  geom_line(aes(y = avg_caries, color = "Total Caries"), size = 1.5) +
  geom_line(aes(y = avg_untreated, color = "Untreated Caries"), size = 1.5) +
  geom_point(aes(y = avg_caries, color = "Total Caries"), size = 3) +
  geom_point(aes(y = avg_untreated, color = "Untreated Caries"), size = 3) +
  scale_color_manual(values = c("Total Caries" = "#667eea", "Untreated Caries" = "#dc3545")) +
  labs(
    title = "National Dental Caries Prevalence Trends (NHANES)",
    subtitle = "Total and untreated caries over two decades",
    x = "Year",
    y = "Prevalence (%)",
    color = "Measure"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "bottom"
  )

ggplotly(p5)
```

<div style="background: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px;">
<strong>‚ö†Ô∏è PLACEHOLDER:</strong> Replace with actual NHANES caries trend analysis including confidence intervals
</div>

---

#### Caries Prevalence by Age Group

```{r nhanes-age-trends}
# PLACEHOLDER: Age-stratified caries trends

age_caries <- nhanes_data %>%
  filter(demographic == "Overall") %>%
  group_by(year, age_group) %>%
  summarise(avg_caries = mean(caries_prevalence, na.rm = TRUE), .groups = "drop")

p6 <- ggplot(age_caries, aes(x = year, y = avg_caries, color = age_group, group = age_group)) +
  geom_line(size = 1) +
  geom_point(size = 2) +
  scale_color_viridis_d(option = "plasma") +
  labs(
    title = "Dental Caries Prevalence by Age Group",
    subtitle = "NHANES data showing age-specific trends",
    x = "Year",
    y = "Caries Prevalence (%)",
    color = "Age Group"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

ggplotly(p6)
```

---

#### Demographic Disparities

```{r nhanes-demographic-trends}
# PLACEHOLDER: Demographic comparison

demo_caries <- nhanes_data %>%
  filter(demographic != "Overall", age_group == "10-19") %>%
  group_by(year, demographic) %>%
  summarise(avg_caries = mean(caries_prevalence, na.rm = TRUE), .groups = "drop")

p7 <- ggplot(demo_caries, aes(x = year, y = avg_caries, color = demographic, group = demographic)) +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  scale_color_brewer(palette = "Set1") +
  labs(
    title = "Caries Prevalence Among Adolescents (10-19) by Sex",
    subtitle = "Examining demographic disparities over time",
    x = "Year",
    y = "Caries Prevalence (%)",
    color = "Demographic"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold"))

ggplotly(p7)
```

<div style="background: #fff3cd; border-left: 5px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px;">
<strong>‚ö†Ô∏è PLACEHOLDER:</strong> Add actual NHANES demographic analysis including:
<ul>
<li>Race/ethnicity stratification</li>
<li>Socioeconomic status comparisons</li>
<li>Inequality trend assessment</li>
</ul>
</div>

---

## Integrated Analysis Preview

### Temporal Alignment Exploration

This section provides a preliminary look at how California Medi-Cal preventive service utilization trends align with national NHANES caries burden.

```{r integrated-preview}
# PLACEHOLDER: Integrated dataset preview
# This should merge CA preventive services with NHANES caries for overlapping years (2013-2020)

# Sample integrated data
integrated_preview <- tibble(
  year = 2013:2020,
  ca_preventive_util = runif(8, 0.4, 0.7),
  nhanes_caries_prev = runif(8, 40, 60)
)

p8 <- ggplot(integrated_preview, aes(x = year)) +
  geom_line(aes(y = ca_preventive_util * 100, color = "CA Preventive Utilization"), size = 1.2) +
  geom_line(aes(y = nhanes_caries_prev, color = "National Caries Prevalence"), size = 1.2) +
  geom_point(aes(y = ca_preventive_util * 100, color = "CA Preventive Utilization"), size = 3) +
  geom_point(aes(y = nhanes_caries_prev, color = "National Caries Prevalence"), size = 3) +
  scale_color_manual(values = c("CA Preventive Utilization" = "#28a745", 
                                 "National Caries Prevalence" = "#dc3545")) +
  labs(
    title = "Temporal Alignment: CA Preventive Services vs. National Caries Burden",
    subtitle = "Exploring ecological associations (2013-2020 overlap period)",
    x = "Year",
    y = "Percentage (%)",
    color = "Measure"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold"),
    legend.position = "bottom"
  )

ggplotly(p8)
```

<div style="background: #d1ecf1; border-left: 5px solid #0c5460; padding: 15px; margin: 20px 0; border-radius: 5px;">
<strong>‚ÑπÔ∏è Note:</strong> The integrated analysis above uses dual y-axes for visualization purposes. The formal statistical analysis examining this relationship using weighted least squares regression can be found in the <a href="statistical_analysis.html">Statistical Analysis</a> section.
</div>

---

## Key EDA Findings

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0;">

<div style="background: #d4edda; border: 2px solid #28a745; border-radius: 10px; padding: 20px;">
<h4 style="color: #155724; margin-top: 0;">‚úÖ California Medi-Cal Patterns</h4>
<ul style="margin-bottom: 0;">
<li><strong>PLACEHOLDER:</strong> Key pattern 1</li>
<li><strong>PLACEHOLDER:</strong> Key pattern 2</li>
<li><strong>PLACEHOLDER:</strong> COVID-19 impact observation</li>
</ul>
</div>

<div style="background: #d4edda; border: 2px solid #28a745; border-radius: 10px; padding: 20px;">
<h4 style="color: #155724; margin-top: 0;">‚úÖ NHANES Trends</h4>
<ul style="margin-bottom: 0;">
<li><strong>PLACEHOLDER:</strong> Overall trend direction</li>
<li><strong>PLACEHOLDER:</strong> Demographic disparity observation</li>
<li><strong>PLACEHOLDER:</strong> Age-specific pattern</li>
</ul>
</div>

<div style="background: #d4edda; border: 2px solid #28a745; border-radius: 10px; padding: 20px;">
<h4 style="color: #155724; margin-top: 0;">‚úÖ Preliminary Insights</h4>
<ul style="margin-bottom: 0;">
<li><strong>PLACEHOLDER:</strong> Potential association</li>
<li><strong>PLACEHOLDER:</strong> Temporal alignment observation</li>
<li><strong>PLACEHOLDER:</strong> Further investigation needed</li>
</ul>
</div>

</div>

---

<div style="text-align: center; margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
<p><strong>Next Steps:</strong> Proceed to <a href="statistical_analysis.html">Statistical Analysis</a> for formal hypothesis testing and regression modeling.</p>
</div>
