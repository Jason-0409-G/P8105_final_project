---
title: "Data Documentation"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(knitr)
library(kableExtra)
```

## {.tabset}

### Codebook

<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px;">
<h2 style="margin-top: 0; color: white;">Data Codebook</h2>
<p style="margin-bottom: 0;">Variable definitions and data structure documentation</p>
</div>

---

#### California Medi-Cal Dental Data

**Source:** California Department of Health Care Services  
**Period:** 2013–2023 (Annual)  
**Type:** Administrative claims data

##### Variable Definitions

```{r ca-codebook, echo=FALSE}
ca_codebook <- tibble::tribble(
  ~Variable,        ~Type,          ~Description,                                    ~Values,
  "year",           "Numeric",      "Reporting calendar year",                       "2013-2023",
  "age_group",      "Factor",       "Standardized age group (12 ordered levels)",    "Age <1, Age 1–2, Age 3–5, Age 6–9, Age 10–14, Age 15–18, Age 19–20, Age 21–34, Age 35–44, Age 45–64, Age 65–74, Age 75+",
  "measure",        "Character",    "Type of dental service",                        "See measure types below",
  "users",          "Numeric",      "Number of individuals using the service",       "Count (numerator)",
  "denominator",    "Numeric",      "Population with ≥3 months continuous eligibility", "Count (denominator)",
  "utilization_rate", "Numeric",    "Service utilization rate (users ÷ denominator)", "Proportion (0-1) or Percentage"
)

kable(ca_codebook, align = "llll", caption = "Table 1: California Medi-Cal Data Variables") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

##### Measure Types

The `measure` variable includes the following service categories:

- **Dental visit** - Annual dental visit
- **Exam/Evaluation** - Exams and oral health evaluations
- **Caries treatment** - Treatment for caries or caries-preventive procedures
- **Treatment services** - Use of dental treatment services
- **Diagnostic services** - Use of diagnostic services
- **Preventive services** - Use of preventive services
- **Restorative services** - Use of restorative services
- **Sealant use** - Use of sealant procedures

---

#### NHANES Oral Health Data

**Source:** Centers for Disease Control and Prevention (CDC) / National Center for Health Statistics (NCHS)  
**Period:** 1999–2020 (Biennial cycles)  
**Type:** National cross-sectional survey with clinical examinations

##### Variable Definitions

```{r nhanes-codebook, echo=FALSE}
nhanes_codebook <- tibble::tribble(
  ~Variable,        ~Type,          ~Description,                                    ~Values,
  "survey_years",   "Character",    "NHANES survey cycle",                          "e.g., '1999-2000', '2001-2002'",
  "year_mid",       "Numeric",      "Mid-point of survey years (for trend analysis)", "e.g., 1999.5, 2001.5",
  "sex",            "Character",    "Biological sex",                               "Male, Female, Both sexes",
  "age_group",      "Character",    "Age group category",                           "2-5, 6-11, 12-19, 20-29, 30-39, 40-49, 50-59, 60-69, 70 and over",
  "race_ethnicity", "Character",    "Race and Hispanic origin",                     "Various categories",
  "measure",        "Character",    "Type of oral health measure (original)",       "See measure types below",
  "measure_clean",  "Character",    "Standardized measure name (short form)",       "total_primary, total_perm, untreated_primary, untreated_perm, sealant_perm, sealant_all",
  "percent",        "Numeric",      "Prevalence percentage",                        "0-100",
  "se",             "Numeric",      "Standard error of estimate",                   "Numeric",
  "ci_lower",       "Numeric",      "Lower 95% confidence interval limit",          "Numeric",
  "ci_upper",       "Numeric",      "Upper 95% confidence interval limit",          "Numeric"
)

kable(nhanes_codebook, align = "llll", caption = "Table 2: NHANES Oral Health Data Variables") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

##### Measure Types

The `measure` variable includes:

- **Total Dental Caries in Primary Teeth** (`total_primary`)
- **Total Dental Caries in Permanent Teeth** (`total_perm`)
- **Untreated Dental Caries in Primary Teeth** (`untreated_primary`)
- **Untreated Dental Caries in Permanent Teeth** (`untreated_perm`)
- **Sealants on Permanent Teeth** (`sealant_perm`)
- **Sealants on Permanent and Primary Teeth** (`sealant_all`)

---

#### Data Files

```{r data-files, echo=FALSE}
data_files <- tibble::tribble(
  ~Dataset,                    ~Filename,                     ~Format,  ~Size,
  "California Medi-Cal (Raw)", "ca_dental.csv",               "CSV",    "TBD",
  "California Medi-Cal (Clean)", "clean_ca.csv",              "CSV",    "TBD",
  "NHANES Oral Health (Raw)",  "nhanes_oral.csv",             "CSV",    "TBD",
  "NHANES Oral Health (Clean)", "nhanes_oral_clean.csv",      "CSV",    "TBD",
  "Data Dictionary",           "ca_dictionary.csv",           "CSV",    "TBD"
)

kable(data_files, caption = "Table 3: Data Files in Repository") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

<div style="background: #d1ecf1; border-left: 5px solid #0c5460; padding: 15px; margin: 20px 0; border-radius: 5px;">
<strong>Note:</strong> All datasets are stored in the <code>datasets/</code> folder in the project repository.
</div>

---

### Data Cleaning

<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; margin-bottom: 30px;">
<h2 style="margin-top: 0; color: white;">Data Cleaning Process</h2>
<p style="margin-bottom: 0;">Reproducible data preparation and harmonization</p>
</div>

---

#### California Medi-Cal Data Cleaning

##### Overview

The original Medi-Cal dental utilization dataset contained multiple annotation fields, coded measure names, and inconsistent formatting across variables. We conducted a structured cleaning process in R to prepare the data for analysis.

##### Cleaning Steps

```{r ca-cleaning, eval=FALSE, echo=TRUE}
library(tidyverse)
library(janitor)

# Read raw data
raw_data <- read_csv("datasets/ca_dental.csv")

# 1️⃣ Define age group order
age_order <- c(
  "Age <1", "Age 1–2", "Age 3–5", "Age 6–9",
  "Age 10–14", "Age 15–18", "Age 19–20", "Age 21–34",
  "Age 35–44", "Age 45–64", "Age 65–74", "Age 75+"
)

# 2️⃣ Clean dataset
clean_data_basic <- raw_data %>%
  # (1) Standardize column names
  clean_names() %>%
  
  # (2) Remove invalid annotation rows
  mutate(desc_clean = str_to_lower(str_squish(users_annotation_description))) %>%
  filter(
    is.na(desc_clean) |
      !desc_clean %in% c(
        "no data available",
        "cell suppressed for small numbers",
        "cell suppressed for complementary cell"
      )
  ) %>%
  select(-desc_clean) %>%
  
  # (3) Clean "measure" text
  mutate(
    measure = measure %>%
      str_replace_all("[–—−]", "-") %>%
      str_remove_all("\\s*\\([^()]*\\)") %>%
      str_squish()
  ) %>%
  
  # (4) Rename important columns
  rename(
    year      = calendar_year,
    age_group = age_filter,
    denominator = denominator_3_months_continuous_eligibility
  ) %>%
  
  # (5) Standardize and order age groups
  mutate(
    age_group = age_group %>%
      str_replace_all("[–—−-]", "–") %>%
      str_squish() %>%
      str_replace_all("^Age\\s*<\\s*1$", "Age <1") %>%
      str_replace_all("^Age 1–2$|^Age 1-2$", "Age 1–2") %>%
      str_replace_all("^Age 3–5$|^Age 3-5$", "Age 3–5") %>%
      str_replace_all("^Age 6–9$|^Age 6-9$", "Age 6–9") %>%
      str_replace_all("^Age 10–14$|^Age 10-14$", "Age 10–14") %>%
      str_replace_all("^Age 15–18$|^Age 15-18$", "Age 15–18") %>%
      str_replace_all("^Age 19–20$|^Age 19-20$", "Age 19–20") %>%
      str_replace_all("^Age 21–34$|^Age 21-34$", "Age 21–34") %>%
      str_replace_all("^Age 35–44$|^Age 35-44$", "Age 35–44") %>%
      str_replace_all("^Age 45–64$|^Age 45-64$", "Age 45–64") %>%
      str_replace_all("^Age 65–74$|^Age 65-74$", "Age 65–74") %>%
      str_replace_all("^Age 75\\+$", "Age 75+"),
    age_group = factor(age_group, levels = age_order)
  ) %>%
  
  # (6) Sort dataset
  arrange(year, age_group, measure)

# 3️⃣ Simplify measure names
clean_data_simple <- clean_data_basic %>%
  mutate(
    measure = case_when(
      measure == "Annual Dental Visit" ~ "Dental visit",
      measure == "Exams/Oral Health Evaluations" ~ "Exam/Evaluation",
      measure == "Treatment for Caries or Caries–Preventive Procedure" ~ "Caries treatment",
      measure == "Use of Dental Treatment Services" ~ "Treatment services",
      measure == "Use of Diagnostic Services" ~ "Diagnostic services",
      measure == "Use of Preventive Services" ~ "Preventive services",
      measure == "Use of Restorative Services" ~ "Restorative services",
      measure == "Use of Sealant" ~ "Sealant use",
      TRUE ~ measure
    )
  )

# 4️⃣ Keep only key variables & simplify names
clean_data_final <- clean_data_simple %>%
  select(
    year,
    age_group,
    measure,
    users,
    denominator,
    utilization_percent   
  ) %>%
  rename(
    utilization_rate = utilization_percent   
  )

# Save cleaned data
write_csv(clean_data_final, "datasets/clean_ca.csv")
```

##### Key Cleaning Operations

1. **Column normalization:** All column names standardized using `janitor::clean_names()`
2. **Invalid record removal:** Excluded rows with missing data or suppressed cells
3. **Measure text cleaning:** Unified dashes, removed parentheses and codes
4. **Age group standardization:** Harmonized age labels (e.g., `Age1-2` → `Age 1–2`)
5. **Annotation removal:** Dropped redundant annotation columns
6. **Variable renaming:** Renamed for clarity (`Calendar.Year` → `year`, etc.)
7. **Measure simplification:** Shortened descriptive measure names

**Final Output:** 6 essential variables (`year`, `age_group`, `measure`, `users`, `denominator`, `utilization_rate`)

---

#### NHANES Data Cleaning

##### Overview

The NHANES oral health dataset required standardization of variable names, cleaning of percentage values, and creation of time variables for trend analysis.

##### Cleaning Steps

```{r nhanes-cleaning, eval=FALSE, echo=TRUE}
library(tidyverse)

# Read raw data
nhanes <- read_csv("datasets/nhanes_oral.csv")

# 1️⃣ Delete useless columns
cols_to_drop <- c("Presentation Standard", "Note1", "Note2", "Notea", "Noteb")
nhanes <- nhanes %>%
  select(-any_of(cols_to_drop))

# 2️⃣ Rename columns
nhanes <- nhanes %>%
  rename(
    survey_years = `Survey Years`,
    sex = Sex,
    age_group = `Age Group`,
    race_ethnicity = `Race and Hispanic Origin`,
    measure = Measure,
    percent = Percent,
    se = `Standard Error`,
    ci_lower = `Lower 95% CI Limit`,
    ci_upper = `Upper 95% CI Limit`
  )

# 3️⃣ Clean percent values
nhanes <- nhanes %>%
  mutate(
    percent = str_replace_all(as.character(percent), "%", ""),
    percent = as.numeric(percent)
  )

# 4️⃣ Clean years and create mid-year variable
nhanes <- nhanes %>%
  mutate(
    survey_years = str_replace_all(survey_years, "–", "-"),
    year_mid = as.numeric(str_sub(survey_years, 1, 4)) + 0.5
  )

# 5️⃣ Standardize measure names
measure_map <- c(
  "Total Dental Caries in Primary Teeth" = "total_primary",
  "Total Dental Caries in Permanent Teeth" = "total_perm",
  "Untreated Dental Caries in Primary Teeth" = "untreated_primary",
  "Untreated Dental Caries in Permanent Teeth" = "untreated_perm",
  "Sealants on Permanent Teeth" = "sealant_perm",
  "Sealants on Permanent and Primary Teeth" = "sealant_all"
)

nhanes <- nhanes %>%
  mutate(measure_clean = recode(measure, !!!measure_map))

# 6️⃣ Filter to specific age groups
nhanes <- nhanes %>%
  filter(age_group %in% c(
    "2-5", "6-11", "12-19",
    "20-29", "30-39", "40-49", "50-59",
    "60-69", "70 and over"
  ))

# 7️⃣ Remove rows with missing percent values
nhanes_clean <- nhanes %>%
  filter(!is.na(percent))

# 8️⃣ Select and order final variables
nhanes_clean <- nhanes_clean %>%
  select(
    survey_years, year_mid, sex, age_group,
    race_ethnicity, measure, measure_clean,
    percent, se, ci_lower, ci_upper
  )

# Save cleaned data
write_csv(nhanes_clean, "datasets/nhanes_oral_clean.csv")
```

##### Key Cleaning Operations

1. **Column removal:** Dropped presentation standards and footnote columns
2. **Variable renaming:** Standardized all column names for consistency
3. **Percentage cleaning:** Removed "%" symbols and converted to numeric
4. **Year variable creation:** Created `year_mid` for continuous time analysis (e.g., "1999-2000" → 1999.5)
5. **Measure standardization:** Created short-form measure codes for analysis
6. **Age group filtering:** Retained only specific age categories (excluded broad groups)
7. **Missing data removal:** Excluded rows with missing prevalence estimates
8. **Variable selection:** Ordered final variables logically

**Final Output:** 11 variables including survey cycle, demographics, measures, and statistical estimates

---

#### Data Quality Checks

<div style="background: #f8f9fa; padding: 20px; border-left: 5px solid #28a745; border-radius: 5px; margin: 20px 0;">
<h4 style="color: #28a745; margin-top: 0;">Quality Assurance</h4>
<p>After cleaning, we performed the following quality checks:</p>
<ul>
<li>✅ No duplicate records</li>
<li>✅ Age groups properly ordered (California: 12 levels, NHANES: 9 levels)</li>
<li>✅ Year ranges complete (California: 2013-2023, NHANES: 1999-2020)</li>
<li>✅ Utilization rates/percentages within valid ranges (0-100%)</li>
<li>✅ No missing values in key variables</li>
<li>✅ Consistent formatting across all text fields</li>
</ul>
</div>

---

##

<div style="text-align: center; margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
<p><strong>Data Repository:</strong> All raw and cleaned datasets, along with data dictionaries, are available in the project's <code>datasets/</code> folder.</p>
<p><em>For questions about data sources or cleaning procedures, please contact the team.</em></p>
</div>
