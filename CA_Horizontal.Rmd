---
title: "CA_Horizontal"
output: github_document
date: "2025-12-02"
---

```{r setup, include=FALSE}
library(tidyverse)
library(knitr)
library(ggplot2)
library(scales)

# Read cleaned CA dataset
ca <- read_csv("datasets/clean_ca.csv")


# Clean formatting: remove commas and percent signs, convert to numeric
ca <- ca %>%
  mutate(
    year = as.numeric(gsub("CY ", "", year)),
    utilization_rate = as.numeric(gsub("%", "", utilization_rate)) / 100,
    age_group = factor(age_group),
    measure = factor(measure)
  )

head(ca)

age_order <- c(
  "Age <1", "Age 1–2", "Age 3–5", "Age 6–9",
  "Age 10–14", "Age 15–18", "Age 19–20", "Age 21–34",
  "Age 35–44", "Age 45–64", "Age 65–74", "Age 75+"
)
```

# Age Group Comparison
### ---- Weighted mean by age group ----
### We consider weighted averages more appropriate because the population size (denominator) differs substantially across service categories.。
### A simple mean can overrepresent service types with small denominators.
### Weighted utilization = total users / total eligible population in each age group
```{r fig.width=12, fig.height=5}
age_summary_weighted <- ca %>%
  group_by(age_group) %>%
  summarise(
    total_users = sum(users, na.rm = TRUE),
    total_denom = sum(denominator, na.rm = TRUE),
    weighted_util = total_users / total_denom
  ) %>%
  arrange(desc(weighted_util))

kable(age_summary_weighted)

# Plot -------------------------------------------------------
library(scales)

age_summary_weighted %>%
  ggplot(aes(x = reorder(age_group, weighted_util), y = weighted_util)) +
  geom_col(fill = "#4C72B0", width = 0.7) +
  geom_text(aes(label = percent(weighted_util, accuracy = 0.1)),
            hjust = -0.05, size = 3.5, color = "gray20") +
  coord_flip() +
  scale_y_continuous(labels = percent_format(accuracy = 1),
                     expand = expansion(mult = c(0, 0.1))) +
  labs(
    title = "Weighted Average Dental Service Utilization by Age Group",
    subtitle = "Weighted by denominator (population size) across all service types, 2013–2022",
    x = "Age Group",
    y = "Weighted Utilization Rate"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 15, hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    axis.text = element_text(color = "gray20"),
    axis.title = element_text(face = "bold"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )
```
After weighting each service type by its population denominator, the overall age-patterns remain similar, but the weighted results better reflect true population-level service use.

 * Children aged 6–9 show the highest weighted utilization (~42.7%).
 * Followed by 3–5 (~39.5%) and 10–14 (~36.4%).
 * Adolescents (15–18) also have relatively high utilization (~33%).
 * Adults over age 45 show substantially lower utilization (<20%).
 * Infants (<1 year) have the lowest utilization (~1.4%).

Compared with the unweighted results, the weighted analysis corrects for small denominators (e.g., younger infants), producing more reliable age comparisons.

In summary:
School-aged children (6–14) are the most active users of dental services, while older adults show potential under-utilization.

# Service Type Comparison
```{r fig.width=12, fig.height=5}
# ---- Service Type Comparison ----
# Compare average weighted utilization across different service types

measure_summary_weighted <- ca %>%
  group_by(measure) %>%
  summarise(
    total_users = sum(users, na.rm = TRUE),
    total_denom = sum(denominator, na.rm = TRUE),
    weighted_util = total_users / total_denom
  ) %>%
  arrange(desc(weighted_util))

kable(measure_summary_weighted)

# Plot ------------------------------------------------------
measure_summary_weighted %>%
  ggplot(aes(x = reorder(measure, weighted_util), y = weighted_util)) +
  geom_col(fill = "#F4A261", width = 0.7) +
  geom_text(aes(label = scales::percent(weighted_util, accuracy = 0.1)),
            hjust = -0.05, size = 3.5, color = "gray20") +
  coord_flip() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                     expand = expansion(mult = c(0, 0.1))) +
  labs(
    title = "Weighted Average Utilization by Service Type",
    subtitle = "Weighted by denominator across all age groups and years (2013–2022)",
    x = "Service Type",
    y = "Weighted Utilization Rate"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 15, hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    axis.text = element_text(color = "gray20"),
    axis.title = element_text(face = "bold"),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )
```

# Age x Service Type Interaction
```{r fig.width=12, fig.height=5}
# Explore differences in utilization across age groups and service types
# Weighted to account for variability in denominator sizes

cross_summary_weighted <- ca %>%
  group_by(age_group, measure) %>%
  summarise(
    total_users = sum(users, na.rm = TRUE),
    total_denom = sum(denominator, na.rm = TRUE),
    weighted_util = total_users / total_denom
  )

cross_summary_weighted <- cross_summary_weighted %>%
  mutate(age_group = factor(age_group, levels = age_order))

# Heatmap --------------------------------------------------------
cross_summary_weighted %>%
  ggplot(aes(x = age_group, y = measure, fill = weighted_util)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "C", labels = scales::percent_format(accuracy = 0.1)) +
  labs(
    title = "Dental Service Utilization by Age Group and Service Type",
    subtitle = "Weighted by denominator (population size)",
    x = "Age Group",
    y = "Service Type",
    fill = "Weighted Utilization"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold", size = 15, hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, color = "gray40"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.text = element_text(color = "gray20"),
    legend.position = "right"
  )
```




